name: Build Rust FFI Libraries

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run the workflow on'
        required: true
        default: 'main'
        
      commit_binaries:
        description: 'Commit FFI binaries to repository'
        required: false
        default: 'true'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'crypto_engine/**'
      - '.github/workflows/rust_ffi_build.yml'
  pull_request:
    paths:
      - 'crypto_engine/**'
      - '.github/workflows/rust_ffi_build.yml'

# Default permissions for all jobs (minimal read access)
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crypto_engine/target
          key: linux-cargo-${{ hashFiles('crypto_engine/Cargo.lock') }}
          restore-keys: linux-cargo-

      - name: Build release
        working-directory: crypto_engine
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Run tests
        working-directory: crypto_engine
        run: cargo test --release

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: crypto_engine/target/x86_64-unknown-linux-gnu/release/libcrypto_engine.so
          if-no-files-found: error

  build-windows:
    name: Build Windows x86_64
    runs-on: windows-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crypto_engine/target
          key: windows-cargo-${{ hashFiles('crypto_engine/Cargo.lock') }}
          restore-keys: windows-cargo-

      - name: Build release
        working-directory: crypto_engine
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Run tests
        working-directory: crypto_engine
        run: cargo test --release

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: crypto_engine/target/x86_64-pc-windows-msvc/release/crypto_engine.dll
          if-no-files-found: error

  build-macos:
    name: Build macOS (x86_64 + ARM64)
    runs-on: macos-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crypto_engine/target
          key: macos-cargo-${{ hashFiles('crypto_engine/Cargo.lock') }}
          restore-keys: macos-cargo-

      - name: Build x86_64
        working-directory: crypto_engine
        run: cargo build --release --target x86_64-apple-darwin

      - name: Build ARM64
        working-directory: crypto_engine
        run: cargo build --release --target aarch64-apple-darwin

      - name: Create universal binary
        working-directory: crypto_engine
        run: |
          mkdir -p target/universal-apple-darwin/release
          lipo -create \
            target/x86_64-apple-darwin/release/libcrypto_engine.dylib \
            target/aarch64-apple-darwin/release/libcrypto_engine.dylib \
            -output target/universal-apple-darwin/release/libcrypto_engine.dylib

      - name: Run tests
        working-directory: crypto_engine
        run: cargo test --release

      - name: Upload macOS x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: crypto_engine/target/x86_64-apple-darwin/release/libcrypto_engine.dylib
          if-no-files-found: error

      - name: Upload macOS ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: crypto_engine/target/aarch64-apple-darwin/release/libcrypto_engine.dylib
          if-no-files-found: error

      - name: Upload macOS Universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: crypto_engine/target/universal-apple-darwin/release/libcrypto_engine.dylib
          if-no-files-found: error

  build-android:
    name: Build Android (arm64-v8a, armeabi-v7a, x86_64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crypto_engine/target
          key: android-cargo-${{ hashFiles('crypto_engine/Cargo.lock') }}
          restore-keys: android-cargo-

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Android targets
        working-directory: crypto_engine
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cargo ndk -t arm64-v8a -t armeabi-v7a -t x86_64 -o ./jniLibs build --release

      - name: Upload Android arm64-v8a artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-v8a
          path: crypto_engine/jniLibs/arm64-v8a/libcrypto_engine.so
          if-no-files-found: error

      - name: Upload Android armeabi-v7a artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-armeabi-v7a
          path: crypto_engine/jniLibs/armeabi-v7a/libcrypto_engine.so
          if-no-files-found: error

      - name: Upload Android x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-x86_64
          path: crypto_engine/jniLibs/x86_64/libcrypto_engine.so
          if-no-files-found: error

  build-ios:
    name: Build iOS (arm64 + simulator)
    runs-on: macos-latest
    env:
      IPHONEOS_DEPLOYMENT_TARGET: "14.0"
      CFLAGS_aarch64_apple_ios: "-mios-version-min=14.0"
      CFLAGS_x86_64_apple_ios: "-mios-version-min=14.0"
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crypto_engine/target
          key: ios-cargo-${{ hashFiles('crypto_engine/Cargo.lock') }}
          restore-keys: ios-cargo-

      - name: Build iOS arm64 (device)
        working-directory: crypto_engine
        run: cargo build --release --target aarch64-apple-ios

      - name: Build iOS arm64 (simulator)
        working-directory: crypto_engine
        run: cargo build --release --target aarch64-apple-ios-sim

      - name: Build iOS x86_64 (simulator)
        working-directory: crypto_engine
        run: cargo build --release --target x86_64-apple-ios

      - name: Create iOS simulator universal binary
        working-directory: crypto_engine
        run: |
          mkdir -p target/ios-simulator-universal/release
          lipo -create \
            target/aarch64-apple-ios-sim/release/libcrypto_engine.a \
            target/x86_64-apple-ios/release/libcrypto_engine.a \
            -output target/ios-simulator-universal/release/libcrypto_engine.a

      - name: Upload iOS device artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-arm64
          path: crypto_engine/target/aarch64-apple-ios/release/libcrypto_engine.a
          if-no-files-found: error

      - name: Upload iOS simulator artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-universal
          path: crypto_engine/target/ios-simulator-universal/release/libcrypto_engine.a
          if-no-files-found: error

  # Commit FFI libraries to the repository for easy integration
  commit-ffi-libraries:
    name: Commit FFI Libraries to Repository
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-android, build-ios]
    if: |
      always() &&
      ((github.event_name == 'workflow_dispatch' && github.event.inputs.commit_binaries == 'true') ||
       (github.event_name == 'push' && github.ref == 'refs/heads/main'))
    permissions:
      contents: write
    steps:
      - name: Check build results
        id: check-builds
        run: |
          # Count successful builds (at least 4 required)
          SUCCESS_COUNT=0
          
          if [ "${{ needs.build-linux.result }}" == "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "build-linux: success"
          else
            echo "build-linux: ${{ needs.build-linux.result }}"
          fi
          
          if [ "${{ needs.build-windows.result }}" == "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "build-windows: success"
          else
            echo "build-windows: ${{ needs.build-windows.result }}"
          fi
          
          if [ "${{ needs.build-macos.result }}" == "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "build-macos: success"
          else
            echo "build-macos: ${{ needs.build-macos.result }}"
          fi
          
          if [ "${{ needs.build-android.result }}" == "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "build-android: success"
          else
            echo "build-android: ${{ needs.build-android.result }}"
          fi
          
          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "build-ios: success"
          else
            echo "build-ios: ${{ needs.build-ios.result }}"
          fi
          
          echo "Total successful builds: $SUCCESS_COUNT"
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          
          if [ $SUCCESS_COUNT -ge 4 ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "At least 4 builds succeeded, proceeding with commit"
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "Less than 4 builds succeeded, skipping commit"
          fi

      - name: Checkout source
        if: steps.check-builds.outputs.proceed == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Download all artifacts
        if: steps.check-builds.outputs.proceed == 'true'
        uses: actions/download-artifact@v4
        with:
          path: ffi-libs

      - name: Display structure of downloaded files
        if: steps.check-builds.outputs.proceed == 'true'
        run: ls -R ffi-libs

      - name: Copy Android libraries to jniLibs
        if: steps.check-builds.outputs.proceed == 'true'
        run: |
          # Create jniLibs directory structure for Android
          mkdir -p android/app/src/main/jniLibs/arm64-v8a
          mkdir -p android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p android/app/src/main/jniLibs/x86_64
          
          # Copy Android libraries with explicit file existence checks
          if [ -f "ffi-libs/android-arm64-v8a/libcrypto_engine.so" ]; then
            cp ffi-libs/android-arm64-v8a/libcrypto_engine.so android/app/src/main/jniLibs/arm64-v8a/
            echo "✓ Copied arm64-v8a library"
          else
            echo "⚠ arm64-v8a library not found in artifacts"
          fi
          
          if [ -f "ffi-libs/android-armeabi-v7a/libcrypto_engine.so" ]; then
            cp ffi-libs/android-armeabi-v7a/libcrypto_engine.so android/app/src/main/jniLibs/armeabi-v7a/
            echo "✓ Copied armeabi-v7a library"
          else
            echo "⚠ armeabi-v7a library not found in artifacts"
          fi
          
          if [ -f "ffi-libs/android-x86_64/libcrypto_engine.so" ]; then
            cp ffi-libs/android-x86_64/libcrypto_engine.so android/app/src/main/jniLibs/x86_64/
            echo "✓ Copied x86_64 library"
          else
            echo "⚠ x86_64 library not found in artifacts"
          fi

      - name: Copy Linux libraries
        if: steps.check-builds.outputs.proceed == 'true'
        run: |
          # Create Linux native library directory
          mkdir -p linux/libs
          if [ -f "ffi-libs/linux-x86_64/libcrypto_engine.so" ]; then
            cp ffi-libs/linux-x86_64/libcrypto_engine.so linux/libs/
            echo "✓ Copied Linux library"
          else
            echo "⚠ Linux library not found in artifacts"
          fi

      - name: Copy Windows libraries
        if: steps.check-builds.outputs.proceed == 'true'
        run: |
          # Create Windows native library directory
          mkdir -p windows/libs
          if [ -f "ffi-libs/windows-x86_64/crypto_engine.dll" ]; then
            cp ffi-libs/windows-x86_64/crypto_engine.dll windows/libs/
            echo "✓ Copied Windows library"
          else
            echo "⚠ Windows library not found in artifacts"
          fi

      - name: Copy macOS libraries
        if: steps.check-builds.outputs.proceed == 'true'
        run: |
          # Create macOS native library directory
          mkdir -p macos/libs
          if [ -f "ffi-libs/macos-universal/libcrypto_engine.dylib" ]; then
            cp ffi-libs/macos-universal/libcrypto_engine.dylib macos/libs/
            echo "✓ Copied macOS library"
          else
            echo "⚠ macOS library not found in artifacts"
          fi

      - name: Copy iOS libraries
        if: steps.check-builds.outputs.proceed == 'true'
        run: |
          # Create iOS native library directory
          mkdir -p ios/libs
          if [ -f "ffi-libs/ios-arm64/libcrypto_engine.a" ]; then
            cp ffi-libs/ios-arm64/libcrypto_engine.a ios/libs/libcrypto_engine-device.a
            echo "✓ Copied iOS device library"
          else
            echo "⚠ iOS device library not found in artifacts"
          fi
          
          if [ -f "ffi-libs/ios-simulator-universal/libcrypto_engine.a" ]; then
            cp ffi-libs/ios-simulator-universal/libcrypto_engine.a ios/libs/libcrypto_engine-simulator.a
            echo "✓ Copied iOS simulator library"
          else
            echo "⚠ iOS simulator library not found in artifacts"
          fi

      - name: Configure Git
        if: steps.check-builds.outputs.proceed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Commit and push FFI libraries
        if: steps.check-builds.outputs.proceed == 'true'
        run: |
          # Add all library files
          git add android/app/src/main/jniLibs/ || true
          git add linux/libs/ || true
          git add windows/libs/ || true
          git add macos/libs/ || true
          git add ios/libs/ || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Update Rust FFI libraries for all platforms

            Built from: ${{ github.sha }}
            Workflow run: ${{ github.run_id }}
            
            Platforms updated:
            - Android (arm64-v8a, armeabi-v7a, x86_64)
            - Linux (x86_64)
            - Windows (x86_64)
            - macOS (Universal)
            - iOS (device + simulator)"
            
            git push
          fi

